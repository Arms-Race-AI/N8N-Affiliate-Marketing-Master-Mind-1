<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BLACKTOP Evidence Verifier</title>
<style>
  body{font-family:Segoe UI,Inter,system-ui,Arial;margin:24px;line-height:1.4}
  .box{padding:16px;border:1px solid #ccc;border-radius:10px;max-width:820px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:10px 0}
  .mono{font-family:ui-monospace,Consolas,monospace;white-space:pre-wrap;word-break:break-all}
  .ok{color:#0a7}
  .warn{color:#b80}
  .err{color:#c22}
</style>
</head>
<body>
<h1>BLACKTOP Evidence Verifier</h1>
<div class="box">
  <div class="row">
    <input type="file" id="file" accept="application/json" />
    <button id="verify">Verify</button>
  </div>
  <div id="status"></div>
  <pre id="out" class="mono"></pre>
</div>
<script>
async function sha256Hex(text){
  const data = new TextEncoder().encode(text);
  const digest = await crypto.subtle.digest('SHA-256', data);
  return Array.from(new Uint8Array(digest)).map(b=> b.toString(16).padStart(2,'0')).join('');
}
function canonicalize(obj){
  const sort = v => (v && typeof v==='object' && !Array.isArray(v))
    ? Object.keys(v).sort().reduce((o,k)=>{ o[k]=sort(v[k]); return o; }, {})
    : Array.isArray(v)? v.map(sort) : v;
  return JSON.stringify(sort(obj));
}
async function verifyPack(pack){
  const claimed = pack.checksum || '';
  const clone = JSON.parse(JSON.stringify(pack));
  delete clone.checksum;
  const canonical = canonicalize(clone);
  const actual = await sha256Hex(canonical);
  return { claimed, actual, match: claimed && claimed.toLowerCase()===actual.toLowerCase(), canonical };
}
document.getElementById('verify').addEventListener('click', async ()=>{
  const f = document.getElementById('file').files[0];
  const status = document.getElementById('status');
  const out = document.getElementById('out');
  out.textContent=''; status.textContent='';
  if(!f){ status.textContent='Pick an evidence JSON file to verify.'; return; }
  try{
    const txt = await f.text();
    const pack = JSON.parse(txt);
    const res = await verifyPack(pack);
    status.innerHTML = res.match? '<b class="ok">PASS</b> checksum matches' : '<b class="err">FAIL</b> checksum mismatch';
    out.textContent = JSON.stringify({claimed:res.claimed, actual:res.actual, pack:{ exportedAt:pack.exportedAt, method:pack.method, compute:pack.compute, inputs:pack.inputs }}, null, 2);
  }catch(e){ status.innerHTML = '<b class="err">ERROR</b> '+e.message; }
});
</script>
</body>
</html>
